<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Interface</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .agent-info {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 60vh;
        }

        .input-panel {
            padding: 30px;
            border-right: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .output-panel {
            padding: 30px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #2c3e50;
            min-height: 400px;
            overflow-y: auto;
        }

        .output.error {
            border-left: 3px solid #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .debug-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="agentName">Loading Agent...</h1>
            <p id="agentDescription">Connecting to your AI agent...</p>
            
            <div class="agent-info">
                <div>
                    <strong>Agent ID:</strong> <span id="agentId">-</span> | 
                    <strong>Framework:</strong> <span id="framework">-</span> |
                    <strong>Port:</strong> <span id="runagentPort">-</span>
                </div>
                <div class="status-badge" id="statusBadge">‚úÖ Ready</div>
            </div>
        </div>

        <div class="main-content">
            <div class="input-panel">
                <div class="form-section">
                    <h3>üìù Input Fields</h3>
                    <div id="dynamicInputs">
                        <!-- Dynamic input fields will be generated here -->
                    </div>
                </div>

                <div class="form-section">
                    <button class="btn btn-info" onclick="discoverEndpoints()">üîç Discover Endpoints</button>
                    <button class="btn btn-primary" onclick="runAgent()" id="runButton">
                        Run Agent
                    </button>
                </div>

                <div class="debug-info" id="debugInfo">
                    Click "Discover Endpoints" to find available endpoints...
                </div>
            </div>

            <div class="output-panel">
                <div class="form-section">
                    <h3>üì§ Raw Agent Response</h3>
                </div>
                
                <div class="output" id="output">Ready to run agent...</div>
            </div>
        </div>
    </div>

    <script>
        let agentInfo = null;
        let runagentUrl = null;
        let discoveredEndpoints = [];

        // Get agent ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const agentId = urlParams.get('agent');

        if (agentId) {
            document.getElementById('agentId').textContent = agentId;
        }

        // Initialize the page
        window.addEventListener('DOMContentLoaded', initializePage);

        async function initializePage() {
            if (!agentId) {
                showError("No agent ID provided in URL");
                return;
            }

            try {
                console.log('üîç Fetching agent info for agent ID:', agentId);
                
                const response = await fetch(`http://localhost:8000/agent/${agentId}`);
                const data = await response.json();
                
                agentInfo = data.agent_info;
                runagentUrl = agentInfo.runagent_url;
                
                console.log('üìã Agent data received:', data);
                console.log('üåê RunAgent URL:', runagentUrl);
                
                // Update UI
                document.getElementById('agentName').textContent = agentInfo.agent_name;
                document.getElementById('agentDescription').textContent = agentInfo.description;
                document.getElementById('framework').textContent = agentInfo.framework?.toUpperCase();
                document.getElementById('runagentPort').textContent = agentInfo.port;
                
                // Generate input fields
                generateInputFields(agentInfo.input_fields || ['message']);
                
                // Auto-discover endpoints on load
                setTimeout(discoverEndpoints, 1000);
                
            } catch (error) {
                console.error('‚ùå Error loading agent:', error);
                showError(`Failed to load agent: ${error.message}`);
            }
        }

        function generateInputFields(inputFields) {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = '';

            inputFields.forEach(field => {
                const group = document.createElement('div');
                group.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.id = field;
                input.name = field;
                input.placeholder = `Enter ${field}`;

                group.appendChild(label);
                group.appendChild(input);
                container.appendChild(group);
            });
        }

        async function discoverEndpoints() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent = "üîç Discovering endpoints...\n";

            try {
                // Try to get the OpenAPI docs
                debugInfo.textContent += `üì° Fetching docs from: ${runagentUrl}/docs\n`;
                
                const docsResponse = await fetch(`${runagentUrl}/docs`);
                if (docsResponse.ok) {
                    const docsHtml = await docsResponse.text();
                    
                    // Extract all /agents/ endpoints
                    const agentEndpoints = [...docsHtml.matchAll(/\/agents\/([^\/\s"]+)(\/[^\/\s"]*)?/g)]
                        .map(match => match[0])
                        .filter((value, index, self) => self.indexOf(value) === index);
                    
                    discoveredEndpoints = agentEndpoints;
                    debugInfo.textContent += `‚úÖ Found agent endpoints: ${discoveredEndpoints.join(', ')}\n`;
                } else {
                    debugInfo.textContent += `‚ùå Could not fetch docs (${docsResponse.status})\n`;
                }

                // Also try common patterns
                const commonEndpoints = [
                    '/agents/main/run',
                    '/agents/main_stream/run', 
                    '/agents/main_stream/stream',
                    '/agents/generic/run',
                    '/agents/basic/run',
                    '/agents/invoke/run',
                    '/run',
                    '/invoke'
                ];

                debugInfo.textContent += "\nüß™ Testing common endpoints:\n";
                
                for (const endpoint of commonEndpoints) {
                    try {
                        const testUrl = `${runagentUrl}${endpoint}`;
                        const testResponse = await fetch(testUrl, { method: 'OPTIONS' });
                        const status = testResponse.status;
                        
                        if (status === 200 || status === 405) { // 405 = Method not allowed but endpoint exists
                            debugInfo.textContent += `  ‚úÖ ${endpoint}: Available (${status})\n`;
                            if (!discoveredEndpoints.includes(endpoint)) {
                                discoveredEndpoints.push(endpoint);
                            }
                        } else {
                            debugInfo.textContent += `  ‚ùå ${endpoint}: ${status}\n`;
                        }
                    } catch (e) {
                        debugInfo.textContent += `  ‚ùå ${endpoint}: Error\n`;
                    }
                }

                if (discoveredEndpoints.length > 0) {
                    debugInfo.textContent += `\nüéØ Will try these endpoints: ${discoveredEndpoints.join(', ')}\n`;
                } else {
                    debugInfo.textContent += "\n‚ùå No working endpoints found\n";
                }

            } catch (error) {
                debugInfo.textContent += `‚ùå Discovery error: ${error.message}\n`;
            }
        }

        function collectInputValues() {
            const values = {};
            const inputs = document.querySelectorAll('#dynamicInputs input');
            
            inputs.forEach(input => {
                if (input.value.trim()) {
                    values[input.name] = input.value.trim();
                }
            });
            
            return values;
        }

        async function runAgent() {
            const output = document.getElementById('output');
            const runButton = document.getElementById('runButton');
            const debugInfo = document.getElementById('debugInfo');
            
            const inputValues = collectInputValues();
            
            if (Object.keys(inputValues).length === 0) {
                showError("Please fill at least one input field");
                return;
            }

            runButton.disabled = true;
            runButton.textContent = "Running...";
            output.textContent = "üöÄ Running agent...\n";

            try {
                console.log('üìù Input values:', inputValues);
                console.log('üåê Using RunAgent URL:', runagentUrl);
                
                // Try discovered endpoints first, then fallbacks
                const endpointsToTry = [
                    ...discoveredEndpoints,
                    '/agents/main/run',
                    '/agents/generic/run',
                    '/agents/basic/run',
                    '/run',
                    '/invoke'
                ];

                debugInfo.textContent += `\nüöÄ Trying ${endpointsToTry.length} endpoints...\n`;
                
                let success = false;
                
                for (const endpoint of endpointsToTry) {
                    try {
                        const url = `${runagentUrl}${endpoint}`;
                        debugInfo.textContent += `üîó Trying: ${endpoint}\n`;
                        console.log(`üîó Trying: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(inputValues)
                        });

                        debugInfo.textContent += `üì° Response: ${response.status}\n`;

                        if (response.ok) {
                            const result = await response.text();
                            console.log('‚úÖ SUCCESS with endpoint:', endpoint);
                            console.log('üì§ Raw result:', result);
                            
                            debugInfo.textContent += `‚úÖ SUCCESS with: ${endpoint}\n`;
                            
                            // Just display the raw result - no parsing
                            output.textContent = `‚úÖ SUCCESS with endpoint: ${endpoint}\n\n${result}`;
                            output.className = 'output';
                            success = true;
                            break;
                        } else {
                            const errorText = await response.text();
                            debugInfo.textContent += `‚ùå Failed: ${response.status}\n`;
                            console.log(`‚ùå ${endpoint} failed:`, response.status, errorText);
                        }

                    } catch (error) {
                        debugInfo.textContent += `‚ùå Error: ${error.message}\n`;
                        console.log(`‚ùå Error with ${endpoint}:`, error.message);
                    }
                }

                if (!success) {
                    throw new Error("All endpoints failed. Check debug info and console for details.");
                }

            } catch (error) {
                console.error('‚ùå Agent execution failed:', error);
                showError(error.message);
            } finally {
                runButton.disabled = false;
                runButton.textContent = "Run Agent";
            }
        }

        function showError(message) {
            const output = document.getElementById('output');
            output.textContent = `‚ùå Error: ${message}`;
            output.className = 'output error';
        }
    </script>
</body>
</html>